#!/usr/bin/env python

from __future__ import print_function

import getopt
import os
import sys
import nsgcli.nsggrok_main
import nsgcli.response_formatter
from nsgcli.version import __version__


usage_msg = """
This script parses input with Grok

Usage:

    nsggrok.py --base-url=url [--token=token] [--network=netid] [--pattern=pattern] [command]
    
    --base-url:  server access URL without the path, for example 'http://nsg.domain.com:9100'
                 --base-url must be provided.
    --token:     server API access token (if the server is configured with user authentication)
    --network:      NetSpyGlass network id (a number, default: 1).    
    --pattern:   Grok pattern to be applied to input text.
    -v, --version:   print version and exit

    all arguments provided on the command line after the last switch are interpreted together as nsggrok command
"""


class InvalidArgsException(Exception):
    pass


def usage():
    print(usage_msg)


if __name__ == '__main__':

    try:
        opts, args = getopt.getopt(sys.argv[1:],
                                   'hb:t:n:p:v',
                                   ['help', 'base-url=', 'token=', 'network=', 'pattern=', 'version'])
    except getopt.GetoptError as ex:
        print('UNKNOWN: Invalid Argument:' + str(ex))
        raise InvalidArgsException

    base_url = os.getenv('NSG_SERVICE_URL')
    token = os.getenv('NSG_API_TOKEN')
    netid = 1
    region = None
    command = ''
    pattern = None
    time_format = nsgcli.response_formatter.TIME_FORMAT_ISO_LOCAL

    for opt, arg in opts:
        if opt in ['-h', '--help']:
            usage()
            sys.exit(3)
        elif opt in ('-b', '--base-url'):
            base_url = arg.rstrip('/ ')
        elif opt in ('-a', '--token'):
            token = arg
        elif opt in ('-n', '--network'):
            netid = arg
        elif opt in ('-p', '--pattern'):
            pattern = arg
        elif opt in ['-v', '--version']:
            print(__version__)
            sys.exit(0)

    if args:
        command = ' '.join(args)

    if not base_url:
        print('--base-url parameter is mandatory')
        raise InvalidArgsException

    if token is None:
        token = ''

    script = nsgcli.nsggrok_main.NsgGrokCommandLine(base_url=base_url, token=token, netid=netid, pattern=pattern)
    try:
        if command:
            # print('Command={0}'.format(script.command))
            script.onecmd(command)
        else:
            script.summary()
            script.prompt = script.base_url + ' > '
            script.cmdloop()
    except KeyboardInterrupt as e:
        sys.exit(0)

